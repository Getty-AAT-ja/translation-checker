<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>評価結果ビューア</title>
  <style>
    body { font-family: sans-serif; margin: 2em; line-height: 1.6; }
    .navigation { margin: 1em 0; }
    .score { font-weight: bold; color: #222; margin-top: 1em; }
    .label { font-weight: bold; margin-top: 1em; }
    .box { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; border-radius: 5px; background: #f9f9f9; }
    button { padding: 0.5em 1em; margin: 0 1em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>評価結果ビューア</h1>
  <div class="navigation">
    <button onclick="prev()">＜ 前へ</button>
    <input
      type="number"
      id="counterInput"
      min="1"
      style="width: 60px; text-align: right;"
    />
    <span id="totalCount"></span>
    <button onclick="next()">次へ ＞</button>
  </div>

  <div id="content"></div>

  <script>
    let items = [];
    let current = 0;
    let currentIndex = 0;

    const evaluationCriteria = {
      1: "情報の抜けが無いか。つまり、「解説文（英語）」にある情報がその訳「解説文（人訳・修正）」で抜け落ちてないか。",
      2: "自然な日本語文であるか。「解説文（人訳・修正）」に対して評価を行ってください。",
      3: "対象を理解するために十分な説明か。「解説文（英語）」に対して評価を行ってください。",
      4: "関連深い専門知識を適切に用いて説明されているか。「解説文（英語）」に対して評価を行ってください。",
      5: "事実ではない内容を含んでいないか。専門知識に基づいて判断してください。「解説文（人訳・修正）」に対して評価を行ってください。",
      6: "元ラベルと日本語ラベルが同じ対象を指しているか。ズレ、曖昧さはないか。",
      7: "分野でよく使われる訳語と一致しているか。「日本語ラベル（人訳）」に対して評価を行ってください。",
      8: "分野でよく使われる訳語と一致しているか。「解説文（人訳・修正）」に対して評価を行ってください。"
    };

    function parseReference(text) {
      if (!text) return "";

      // 改行やスペースの後にURLが来るパターンに対応し、日付はあってもなくてもよい
      const match = text.match(/^(.*?)[\s\n]*(https?:\/\/[^\s]+)(?:\s+\d{4}-\d{1,2}-\d{1,2})?$/);
      if (match) {
        const label = match[1].trim();
        const url = match[2];
        return `<a href="${url}" target="_blank">${label}</a>`;
      }

      return text; // マッチしなければそのまま返す
    }

    function setupCounterInputNavigation() {
      const input = document.getElementById("counterInput");
      if (!input) return; // 要素が存在しない場合は何もしない

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const inputVal = parseInt(e.target.value);
          if (!isNaN(inputVal) && inputVal >= 1 && inputVal <= items.length) {
            current = inputVal - 1;
            renderItem(current);
          } else {
            alert("1〜" + items.length + " の範囲で入力してください。");
          }
        }
      });
    }

    function renderItem(index) {
      const item = items[index];
      if (!item) return;

      document.getElementById("counterInput").value = index + 1;
      document.getElementById("totalCount").textContent = "/ " + items.length;

      const content = document.getElementById("content");
      const counter = document.getElementById("counterInput");

      const leftLabel = item["ラベル原文"] || "";
      const rightLabel = item["日本語ラベル(人訳)"] || "";
      const leftDesc = item["解説原文"] || "";
      const rightDesc = item["解説文(人訳)"] || "";

      let html = `
        <div style="display: flex; gap: 20px;">
          <div style="flex: 1; border-right: 1px solid #ccc; padding-right: 10px;">
            <h3>元ラベル</h3>
            <div>${leftLabel}</div>
            <h3>解説文（英語）</h3>
            <div>${leftDesc}</div>
          </div>
          <div style="flex: 1; padding-left: 10px;">
            <h3>日本語ラベル（人訳）</h3>
            <div>${rightLabel}</div>
            <h3>解説文（人訳・修正）</h3>
            <div>${rightDesc}</div>
          </div>
        </div>
        <div class="additional-info">
          <p><strong>リソース:</strong><br><a href="${item["リソース"]}" target="_blank">${item["リソース"]}</a></p>
          <p><strong>タイプ:</strong><br>${item["タイプ"]}</p>
          <p><strong>文献:</strong></p>
          <ul>
            <li>${parseReference(item["文献1"])}</li>
            <li>${parseReference(item["文献2"])}</li>
            <li>${parseReference(item["文献3"])}</li>
          </ul>
          <p><strong>通番:</strong><br>${item["通番"]}</p>
        </div>
        <hr>
      `;

      for (let i = 1; i <= 8; i++) {
        const score = item[`Score_${i}`];
        const reason = item[`Reason_${i}`];
        if (score !== "" || reason !== "") {
          const criteria = evaluationCriteria[i] || "";
          html += `
            <div class="score"><strong>(${i}) ${criteria}</strong></div>
            <div>スコア: ${Math.round(score) || "?"}/5</div>
            <div>${reason || ""}</div>
            <br>
          `;
        }
      }

      html += `</div>`;

      content.innerHTML = html;
      counter.textContent = `${index + 1} / ${items.length}`;
    }

    function prev() {
      if (current > 0) {
        current--;
        renderItem(current);
      }
    }

    function next() {
      if (current < items.length - 1) {
        current++;
        renderItem(current);
      }
    }

    function setupKeyNavigation() {
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          current = Math.max(0, current - 1);
          renderItem(current);
        } else if (e.key === "ArrowRight") {
          current = Math.min(items.length - 1, current + 1);
          renderItem(current);
        }
      });
    }

    // CSVファイルを読み込んで初期表示
    fetch("output_with_scores.csv")
      .then(response => response.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        items = parsed.data;
        if (items.length > 0) {
          renderItem(current);
        } else {
          document.getElementById("content").innerHTML = "データがありません。";
        }
      })
      .then(() => {
        // items の準備ができた後にナビゲーションイベントを登録
        if (items.length > 0) {
          setupKeyNavigation();
          setupCounterInputNavigation();
        }
      })
      .catch(error => {
        document.getElementById("content").innerHTML = "CSVの読み込みに失敗しました。";
        console.error(error);
      });
  </script>
</body>
</html>
