<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>評価結果ビューア</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif; margin: 2em; line-height: 1.6; }
    .navigation { margin: 1em 0; display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .score { font-weight: bold; color: #222; margin-top: 1em; }
    .box { border: 1px solid #ccc; padding: 1em; margin: 1em 0; border-radius: 8px; background: #fafafa; }
    button { padding: .5em .9em; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; }
    button:hover { background: #f2f2f2; }
    input[type="number"] { padding: .4em; border-radius: 6px; border: 1px solid #ccc; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 1fr 1fr; } .col { padding: 10px; } .col.left { border-right: 1px solid #ddd; } }
    .muted { color: #666; }
    .meta p{ margin:.25em 0 }
    .meta ul{ margin-top:.25em }
    .giscus-wrap{ margin-top:2rem }
    .error { color:#b00020; font-weight:600 }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>評価結果ビューア</h1>

  <div class="navigation">
    <button onclick="prev()">＜ 前へ</button>
    <label for="counterInput" class="muted">#</label>
    <input type="number" id="counterInput" min="1" style="width: 80px; text-align: right;" />
    <span id="totalCount" class="muted"></span>
    <button onclick="next()">次へ ＞</button>
    <span id="currentKey" class="muted" title="現在のAAT ID" style="margin-left:auto"></span>
  </div>

  <div id="alerts"></div>
  <div id="content"></div>

  <div class="box" style="background:#f7fbff;border-color:#cfe8ff">
    <p>GitHub Discussion
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.5rem;">
    <button onclick="openCommentsPopup()">コメントを見る / 投稿する（ポップアップ）</button>
    <button onclick="openCreateDiscussionPopup()">新規ディスカッションを作成</button>
    <span class="muted">対象URL: <code id="targetUrl"></code></span>
    </div>
  </div>

  <script>
    // ================================
    //  設定: CSV パス
    // ================================
    const CSV_PATH = "output_with_scores.csv";

    // ================================
    //  状態
    // ================================
    let items = [];
    let current = -1; // 未決定

    const evaluationCriteria = {
      1: "情報の抜けが無いか。つまり、「解説文（英語）」にある情報がその訳「解説文（人訳・修正）」で抜け落ちてないか。",
      2: "自然な日本語文であるか。「解説文（人訳・修正）」に対して評価を行ってください。",
      3: "対象を理解するために十分な説明か。「解説文（英語）」に対して評価を行ってください。",
      4: "関連深い専門知識を適切に用いて説明されているか。「解説文（英語）」に対して評価を行ってください。",
      5: "事実ではない内容を含んでいないか。専門知識に基づいて判断してください。「解説文（人訳・修正）」に対して評価を行ってください。",
      6: "元ラベルと日本語ラベルが同じ対象を指しているか。ズレ、曖昧さはないか。",
      7: "分野でよく使われる訳語と一致しているか。「日本語ラベル（人訳）」に対して評価を行ってください。",
      8: "分野でよく使われる訳語と一致しているか。「解説文（人訳・修正）」に対して評価を行ってください。"
    };

    // ================================
    //  ユーティリティ
    // ================================
    function showAlert(msg){
      const el = document.getElementById('alerts');
      const box = document.createElement('div');
      box.className = 'box error';
      box.textContent = msg;
      el.innerHTML = '';
      el.appendChild(box);
    }

    function parseReference(text) {
      if (!text) return "";
      const match = text.match(/^(.*?)[\s\n]*(https?:\/\/[^\s]+)(?:\s+\d{4}-\d{1,2}-\d{1,2})?$/);
      if (match) {
        const label = match[1].trim();
        const url = match[2];
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      }
      return text;
    }

    function extractAatIdFromResource(res){
      if (!res) return null;
      const m = String(res).match(/(\d+)(?:\/?|#.*)?$/);
      return m ? m[1] : null;
    }

    function getAatIdForIndex(index){
      const item = items[index];
      const id = extractAatIdFromResource(item?.["リソース"]);
      if (!id){
        console.error(`[AAT ID missing] index=${index+1} resource="${item?.["リソース"] ?? ''}"`);
        return null;
      }
      return id;
    }

    function findIndexByAatId(id){
      if (!id) return -1;
      return items.findIndex(it => extractAatIdFromResource(it?.["リソース"]) === String(id));
    }

    function updateURLWithAatId(aatId, replace=false){
      if (!aatId){
        console.error('[URL not updated] Missing AAT ID.');
        return;
      }
      const url = new URL(window.location.href);
      url.search = '';
      url.searchParams.set('item', aatId);
      if (replace){
        history.replaceState({ aatId }, '', url.toString());
      } else {
        history.pushState({ aatId }, '', url.toString());
      }
      document.getElementById('currentKey').textContent = 'AAT ID: ' + aatId;
    }

    function reloadGiscus(){
      const cont = document.getElementById('giscus_thread');
      if (!cont) return;
      cont.innerHTML = '';
      const s = document.createElement('script');
      s.src = 'https://giscus.app/client.js';
      s.setAttribute('data-repo', 'Getty-AAT-ja/translation-checker');
      s.setAttribute('data-repo-id', 'R_kgDOO5CiOg');
      s.setAttribute('data-category', 'Proposal');
      s.setAttribute('data-category-id', 'DIC_kwDOO5CiOs4Cu_jQ');
      s.setAttribute('data-mapping', 'url');
      s.setAttribute('data-strict', '0'); // 完全一致にしたい場合は "1"
      s.setAttribute('data-reactions-enabled', '1');
      s.setAttribute('data-emit-metadata', '0');
      s.setAttribute('data-input-position', 'bottom');
      s.setAttribute('data-theme', 'preferred_color_scheme');
      s.setAttribute('data-lang', 'ja');
      s.setAttribute('crossorigin', 'anonymous');
      s.async = true;
      cont.appendChild(s);
    }

    function renderItem(index){
      const item = items[index];
      if (!item) return;

      const aatId = getAatIdForIndex(index);
      if (!aatId){
        showAlert('このアイテムには AAT の数値IDが見つかりません（詳細はコンソールを参照）。処理を中断します。');
        return;
      }

      document.getElementById('counterInput').value = index + 1;
      document.getElementById('totalCount').textContent = '/ ' + items.length;

      const content = document.getElementById('content');
      const leftLabel = item["ラベル原文"] || "";
      const rightLabel = item["日本語ラベル(人訳)"] || "";
      const leftDesc = item["解説原文"] || "";
      const rightDesc = item["解説文(人訳)"] || "";

      let html = `
        <div class="grid">
          <div class="col left">
            <h3>元ラベル</h3>
            <div>${leftLabel}</div>
            <h3>解説文（英語）</h3>
            <div>${leftDesc}</div>
          </div>
          <div class="col">
            <h3>日本語ラベル（人訳）</h3>
            <div>${rightLabel}</div>
            <h3>解説文（人訳・修正）</h3>
            <div>${rightDesc}</div>
          </div>
        </div>
        <div class="box meta">
          <p><strong>リソース:</strong><br>${item["リソース"] ? `<a href="${item["リソース"]}" target="_blank" rel="noopener noreferrer">${item["リソース"]}</a>` : ''}</p>
          <p><strong>タイプ:</strong><br>${item["タイプ"] || ''}</p>
          <p><strong>文献:</strong></p>
          <ul>
            <li>${parseReference(item["文献1"])}</li>
            <li>${parseReference(item["文献2"])}</li>
            <li>${parseReference(item["文献3"])}</li>
          </ul>
          <p><strong>AAT ID:</strong><br>${aatId}</p>
        </div>
        <hr />
      `;

      for (let i=1; i<=8; i++){
        const score = item[`Score_${i}`];
        const reason = item[`Reason_${i}`];
        if (String(score ?? '') !== '' || String(reason ?? '') !== ''){
          const criteria = evaluationCriteria[i] || '';
          const scoreDisp = (score !== undefined && score !== null && score !== '') ? Math.round(score) : '?';
          html += `
            <div class="score"><strong>(${i}) ${criteria}</strong></div>
            <div>スコア: ${scoreDisp}/5</div>
            <div>${reason || ''}</div>
            <br />
          `;
        }
      }

      document.getElementById('alerts').innerHTML = '';
      content.innerHTML = html;

      // URL をキーにするため、URL更新後に毎回 giscus を再初期化
      updateURLWithAatId(aatId, /*replace*/ true);
      reloadGiscus();
    }

    function goToIndex(index){
      if (index < 0 || index >= items.length){
        console.error(`[out of range] index=${index}`);
        return;
      }
      const aatId = getAatIdForIndex(index);
      if (!aatId){
        showAlert('このアイテムには AAT の数値IDが見つかりません（詳細はコンソールを参照）。移動を中止しました。');
        return;
      }
      current = index;
      document.getElementById('alerts').innerHTML = '';
      updateURLWithAatId(aatId);
      renderItem(index);
    }

    function prev(){ if (current <= 0){ console.error('[nav] already at first item'); return; } goToIndex(current - 1); }
    function next(){ if (current >= items.length - 1){ console.error('[nav] already at last item'); return; } goToIndex(current + 1); }

    function setupKeyNavigation(){
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { prev(); }
        else if (e.key === 'ArrowRight') { next(); }
      });
    }

    function setupCounterInputNavigation(){
      const input = document.getElementById('counterInput');
      if (!input) return;
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter'){
          const val = parseInt(e.target.value);
          if (!Number.isNaN(val)) goToIndex(val - 1);
        }
      });
    }

    // popstate（戻る/進む）: URL の AAT ID に従って移動（fallbackなし）
    window.addEventListener('popstate', () => {
      if (!items.length) return;
      const url = new URL(window.location.href);
      const slug = url.searchParams.get('item');
      if (!slug){
        console.error('[popstate] URL に ?item=<AAT_ID> が必要です');
        showAlert('URL に ?item=<AAT_ID> が必要です。');
        return;
      }
      const idx = findIndexByAatId(slug);
      if (idx === -1){
        console.error(`[popstate] 指定 AAT ID が CSV に見つかりません: ${slug}`);
        showAlert('指定された AAT ID の行が CSV に見つかりません。');
        return;
      }
      current = idx;
      renderItem(idx);
    });

    // CSV 読み込み→初期表示
    fetch(CSV_PATH)
      .then(r => r.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        items = parsed.data;
        document.getElementById('totalCount').textContent = '/ ' + items.length;

        const url = new URL(window.location.href);
        const slug = url.searchParams.get('item');
        if (!slug){
          console.error('[init] URL に ?item=<AAT_ID> が必要です');
          showAlert('URL に ?item=<AAT_ID> が必要です。例: ?item=300133025');
          return; // fallback しない
        }
        const startIndex = findIndexByAatId(slug);
        if (startIndex === -1){
          console.error(`[init] 指定 AAT ID が CSV に見つかりません: ${slug}`);
          showAlert('指定された AAT ID の行が CSV に見つかりません。');
          return; // fallback しない
        }
        current = startIndex;
        renderItem(startIndex);
        setupKeyNavigation();
        setupCounterInputNavigation();
      })
      .catch(err => {
        console.error('[csv] 読み込みエラー:', err);
        showAlert('CSV の読み込みに失敗しました。');
      });


      function getTargetUrl() {
        // canonical がある場合はそちらを使いたければ以下で取得して置換してください
        // const c = document.querySelector('link[rel="canonical"]');
        // return c ? c.href : location.href;
        return location.href;
      }

      function getDiscussionSearchURL() {
        const q = encodeURIComponent(getTargetUrl());
        return `https://github.com/Getty-AAT-ja/translation-checker/discussions?discussions_q=${q}`;
      }

      function getDiscussionCreateURL() {
        const q = encodeURIComponent(getTargetUrl());
        const t = encodeURIComponent(document.title || 'Discussion for this page');
        return `https://github.com/Getty-AAT-ja/translation-checker/discussions/new?category=Proposal&title=${t}&body=${q}`;
      }

      function openPopup(url, name = 'discussion_popup', w = 960, h = 720) {
        const y = window.top.outerHeight / 2 + window.top.screenY - ( h / 2);
        const x = window.top.outerWidth / 2 + window.top.screenX - ( w / 2);
        const feats = `popup=yes,toolbar=no,location=yes,status=no,menubar=no,scrollbars=yes,resizable=yes,width=${w},height=${h},top=${Math.max(0, y)},left=${Math.max(0, x)}`;
        const win = window.open(url, name, feats);
        if (!win) {
        alert('ポップアップをブロックしている可能性があります。このサイトのポップアップを許可してください。');
        }
        return win;
      }

      function openCommentsPopup() {
        openPopup(getDiscussionSearchURL());
      }


      function openCreateDiscussionPopup() {
        openPopup(getDiscussionCreateURL(), 'discussion_create');
      }

      // 表示上、現在の対象URLを明示
      (function initTargetUrlBadge(){
        const el = document.getElementById('targetUrl');
        if (el) el.textContent = getTargetUrl();
      })();
  </script>
</body>
</html>